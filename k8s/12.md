# ConfigMaps

I have fixed my app to show error when 0 API calls left.

## Task 1

I have updated my application to work with file /volume/visits. In this file I store number of visits of index page.

Moreover, I have update `docker-compose` template for ansible and some other values.

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# ansible-playbook playbooks/dev/app_python/main.yaml

PLAY [Deploy Python app in Docker] *************************************************************************************

TASK [Gathering Facts] *************************************************************************************************
ok: [localhost]

...
```

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# curl http://localhost:8000/visits
1
```

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# cat /python_app/docker-compose/volume/visits
1
```

```
/app $ cat ./volume/visits 
1
```

## Task 2

`helm install python . --values values.python.yaml`

```
NAME: python
LAST DEPLOYED: Sun Nov 19 14:16:09 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services python-helm-chart-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT
```

`kubectl get configmap`

```
NAME               DATA   AGE
kube-root-ca.crt   1      18d
my-configmap       1      43s
```

`kubectl exec -it python-helm-chart-app-65d7d9dbd9-2qb4q /bin/sh`

```
/app $ cat /config.json
{"key": "value"}
```

## Bonus

### Persistence logic 

I have updated my application to work with file /volume/visits. In this file I store number of visits of index page.

I used ansible template to run `docker-compose`.

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# ansible-playbook playbooks/dev/app_c#/main.yaml

PLAY [Deploy C# app in Docker] *****************************************************************************************

TASK [Gathering Facts] *************************************************************************************************
ok: [localhost]

...
```

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# curl http://localhost:8080/visits
1
```

```
root@DESKTOP-92PM701:/mnt/c/Users/Damir/Documents/devops-course/ansible# cat /c#_app/docker-compose/volume/visits
1
```

```
/app $ cat ./volume/visits 
1
```

### ConfigMap via environment variables

`kubectl get configmap`

```
NAME               DATA   AGE
kube-root-ca.crt   1      19d
my-configmap       1      3m2s
my-env-configmap   1      3m2s
```

`kubectl exec -it python-helm-chart-app-6bb9dc8b98-m8wbq -- printenv | Select-String -SimpleMatch "CONFIGMAP_VAR"`

```
CONFIGMAP_VAR=SECRET_VALUE
```