# Secrets

## Task 1

### Kubectl

```
PS C:\Users\Damir\Documents\devops-course\k8s> kubectl apply -f secret.yml
secret/secret-base created

PS C:\Users\Damir\Documents\devops-course\k8s> kubectl get secrets secret-base -o yaml
apiVersion: v1
data:
  password: UEFTU1dPUkQ=
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"UEFTU1dPUkQ="},"kind":"Secret","metadata":{"annotations":{},"name":"secret-base","namespace":"default"},"type":"Opaque"}
  creationTimestamp: "2023-11-13T11:42:12Z"
  name: secret-base
  namespace: default
  resourceVersion: "20634"
  uid: ff7f9db8-5a72-47de-a347-f02390bcf5ff
type: Opaque

PS C:\Users\Damir\Documents\devops-course\k8s> kubectl get secrets secret-base -o jsonpath='{.data.password}'
UEFTU1dPUkQ=

PS C:\Users\Damir\Documents\devops-course\k8s> [Text.Encoding]::Utf8.GetString([Convert]::FromBase64String('UEFTU1dPUkQ='))
PASSWORD
```

### Helm

I use Windows woth PowerShell, thererfore I used `Select-String` instead of `grep`

```
PS C:\Users\Damir\Documents\devops-course\k8s\helm-chart-app> kubectl get po
NAME                                    READY   STATUS    RESTARTS   AGE
python-helm-chart-app-56fb57b94-6fp6m   1/1     Running   0          5m42s
python-helm-chart-app-56fb57b94-cw8ht   1/1     Running   0          5m42s
python-helm-chart-app-56fb57b94-jlj9w   1/1     Running   0          5m42s

kubectl exec python-helm-chart-app-56fb57b94-6fp6m -- printenv | Select-String -SimpleMatch "PASSWORD"

PASSWORD=PASSWORD
```

## Task 2

### Install

```
PS C:\Users\Damir\Documents\devops-course\k8s> helm install vault hashicorp/vault --set "server.dev.enabled=true"
NAME: vault
LAST DEPLOYED: Tue Nov 14 13:57:55 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
...

PS C:\Users\Damir\Documents\devops-course\k8s> kubectl get pods
NAME                                    READY   STATUS    RESTARTS   AGE
vault-0                                 1/1     Running   0          39s
vault-agent-injector-5cd8b87c6c-vdwsj   1/1     Running   0          39s
```

### Configuration

`Set a secret`

```
PS C:\Users\Damir\Documents\devops-course\k8s> kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T10:59:00.532733105Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T10:59:00.532733105Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

`Kubernetes authentication`

```
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
```

`Check`

```
PS C:\Users\Damir\Documents\devops-course\k8s\helm-chart-app> kubectl get sa -n default
NAME                   SECRETS   AGE
default                0         13d
internal-app           0         36s
vault                  0         22m
vault-agent-injector   0         22m

PS C:\Users\Damir\Documents\devops-course\k8s\helm-chart-app> kubectl get pods
NAME                                     READY   STATUS    RESTARTS   AGE
python-helm-chart-app-5c95cbdfd4-9ld55   2/2     Running   0          69s
python-helm-chart-app-5c95cbdfd4-sqhcn   2/2     Running   0          69s
python-helm-chart-app-5c95cbdfd4-v2rgf   2/2     Running   0          69s
vault-0                                  1/1     Running   0          23m
vault-agent-injector-5cd8b87c6c-vdwsj    1/1     Running   0          23m

PS C:\Users\Damir\Documents\devops-course\k8s\helm-chart-app> kubectl exec python-helm-chart-app-5c95cbdfd4-9ld55 -it /bin/sh
Defaulted container "helm-chart-app" out of: helm-chart-app, vault-agent, vault-agent-init (init)

/app $ cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2023-11-14T10:59:00.532733105Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```